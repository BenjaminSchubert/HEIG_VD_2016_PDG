\documentclass[french]{article}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lipsum}
\usepackage{lmodern}
\usepackage{geometry}
\usepackage{babel}
\usepackage{graphicx}
\usepackage{lastpage}
\usepackage{ragged2e}
\usepackage{enumitem}
\usepackage[normalem]{ulem}
\usepackage{hyperref} % pour \url{URL}
\usepackage{color} % pour \textcolor{color}{text}
\usepackage{listings} % pour afficher du code
\usepackage{longtable} % pour l'environnement longtable
\usepackage{float} % pour des figures non flottantes
\usepackage{amsmath}
\usepackage{verbatim} % pour les graphes
\usepackage{caption} % figure et subfigure pour mettre les images côtes à côtes
\usepackage{subcaption}
\usepackage{dirtree}
\usepackage{pdfpages}
% Pdf
\setboolean{@twoside}{false}

% Grammaire EBNF
\usepackage{syntax}
\setlength{\grammarparsep}{5pt plus 1pt minus 1pt}
\setlength{\grammarindent}{11em}

% Dessin avec tikz
\usepackage{tikz}
\usetikzlibrary{shapes,arrows,positioning,shadows,matrix,automata}

% Matrices
\usepackage{kbordermatrix}% http://www.hss.caltech.edu/~kcb/TeX/kbordermatrix.sty

% Largeur de colonnes de tableau fixes
\usepackage{array}
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}


% CSS
\lstdefinelanguage{CSS}{
	keywords={color,background-image:,margin,padding,font,weight,display,position,top,left,right,bottom,list,style,border,size,white,space,min,width, transition:, transform:, transition-property, transition-duration, transition-timing-function},	
	sensitive=true,
	morecomment=[l]{//},
	morecomment=[s]{/*}{*/},
	morestring=[b]',
	morestring=[b]",
	alsoletter={:},
	alsodigit={-}
}

% JavaScript
\lstdefinelanguage{JavaScript}{
	morekeywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break, let},
	morecomment=[s]{/*}{*/},
	morecomment=[l]//,
	morestring=[b]",
	morestring=[b]',
	morestring=[s]{/[}{/;}
}

\lstdefinelanguage{HTML5}{
	language=html,
	sensitive=true,	
	alsoletter={<>=-},	
	morecomment=[s]{<!-}{-->},
	tag=[s],
	otherkeywords={
		% General
		>,
		% Standard tags
		<!DOCTYPE,
		</html, <html, <head, <title, </title, <style, </style, <link, </head, <meta, />,
		% body
		</body, <body,
		% Divs
		</div, <div, </div>, 
		% Paragraphs
		</p, <p, </p>,
		% scripts
		</script, <script,
		% More tags...
		<canvas, /canvas>, <svg, <rect, <animateTransform, </rect>, </svg>, <video, <source, <iframe, </iframe>, </video>, <image, </image>, <header, </header, <article, </article
	},
	ndkeywords={
		% General
		=,
		% HTML attributes
		charset=, src=, id=, width=, height=, style=, type=, rel=, href=,
		% SVG attributes
		fill=, attributeName=, begin=, dur=, from=, to=, poster=, controls=, x=, y=, repeatCount=, xlink:href=,
		% properties
		margin:, padding:, background-image:, border:, top:, left:, position:, width:, height:, margin-top:, margin-bottom:, font-size:, line-height:,
		% CSS3 properties
		transform:, -moz-transform:, -webkit-transform:,
		animation:, -webkit-animation:,
		transition:,  transition-duration:, transition-property:, transition-timing-function:,
	}
}

\lstdefinestyle{htmlcssjs} {%
	% General design
	%  backgroundcolor=\color{editorGray},
	basicstyle={\footnotesize\ttfamily},   
	frame=b,
	% line-numbers
	xleftmargin={0.75cm},
	numbers=left,
	stepnumber=1,
	firstnumber=1,
	numberfirstline=true,	
	% Code design
	identifierstyle=\color{black},
	keywordstyle=\color{blue}\bfseries,
	ndkeywordstyle=\color{black}\bfseries,
	stringstyle=\color{brown}\ttfamily,
	commentstyle=\color{gray}\ttfamily,
	% Code
	language=HTML5,
	alsolanguage=JavaScript,
	alsodigit={.:;},	
	tabsize=2,
	showtabs=false,
	showspaces=false,
	showstringspaces=false,
	extendedchars=true,
	breaklines=true,
	% German umlauts
	literate=%
	{Ö}{{\"O}}1
	{Ä}{{\"A}}1
	{Ü}{{\"U}}1
	{ß}{{\ss}}1
	{ü}{{\"u}}1
	{ä}{{\"a}}1
	{ö}{{\"o}}1
}
%
\lstdefinestyle{py} {%
	language=python,
	literate=%
	*{0}{{{\color{red}0}}}1
	{1}{{{\color{red}1}}}1
	{2}{{{\color{red}2}}}1
	{3}{{{\color{red}3}}}1
	{4}{{{\color{red}4}}}1
	{5}{{{\color{red}5}}}1
	{6}{{{\color{red}6}}}1
	{7}{{{\color{red}7}}}1
	{8}{{{\color{red}8}}}1
	{9}{{{\color{red}9}}}1,
	basicstyle=\footnotesize\ttfamily, % Standardschrift
	numbers=left,               % Ort der Zeilennummern
	%numberstyle=\tiny,          % Stil der Zeilennummern
	%stepnumber=2,               % Abstand zwischen den Zeilennummern
	numbersep=5pt,              % Abstand der Nummern zum Text
	tabsize=4,                  % Groesse von Tabs
	extendedchars=true,         %
	breaklines=true,            % Zeilen werden Umgebrochen
	keywordstyle=\color{blue}\bfseries,
	frame=b,
	commentstyle=\color{gray}\itshape,
	stringstyle=\color{brown}\ttfamily, % Farbe der String
	showspaces=false,           % Leerzeichen anzeigen ?
	showtabs=false,             % Tabs anzeigen ?
	xleftmargin=17pt,
	framexleftmargin=17pt,
	framexrightmargin=5pt,
	framexbottommargin=4pt,
	%backgroundcolor=\color{lightgray},
	showstringspaces=false,      % Leerzeichen in Strings anzeigen ?
}%

\geometry{
	a4paper,
	total={210mm,297mm},
	left=20mm,
	right=20mm,
	top=20mm,
	bottom=20mm,
}

\usepackage{fancyhdr}
\pagestyle{fancy}
\setlist[enumerate,1]{leftmargin=2cm}

% Entêtes
\lhead{Champion, Loiseau\\Rochat, Schubert}
\chead{}
\rhead{PDG: Manuel utilisateur}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

\begin{document}
	
	
	% Titre du document
	\title{Projet Rady} % ou un autre nom\centering
	\author{Manuel d'installation\\ 
		Projet de groupe\\
		Champion, Loiseau, Rochat, Schubert\\
		Resp. René Rentsch\\
		HEIG-VD}
	\date{\today} % date du jour
	\maketitle
	\vspace{2cm}
	\centering
	\includegraphics[scale=0.3]{../logo/icone}
	\thispagestyle{empty}
	
	\newpage
	\thispagestyle{empty}
	$ $
	\newpage
	
	% Pour tout le document
	\justify
	\normalsize
	
	% Tables des matières
	\tableofcontents
	
	\newpage	
	\section{Introduction}
	Ce manuel décrit l'installation et la configuration du projet Rady.
	
	En cas de problème avec ce manuel, vous pouvez en tout temps nous contacter à rady@benschubert.me.

	Cordialement.
	\newline
	L'équipe de développement Rady.
		
	\section{Serveur}

	Le serveur de l'application Rady se base sur plusieurs composants dont l'installation est définie ci-dessous.
	
	Le manuel d'installation prévoit l'utilisation sur un serveur linux Ubuntu 16.04 LTS. D'autres versions de linux et Windows peuvent potentiellement fonctionner mais ne sont pas officiellement supportées.
	
	Les composants du serveurs sont :
	
	\begin{itemize}
		\item PostgreSQL (ou autre moteur de base de donnée) pour stocker les données de l'application
		\item Django pour gérer les données dynamiques
		\item Uwsgi pour coordonner l'accès de Nginx à Django
		\item Nginx pour servir les fichiers statiques et le proxy vers Django
	\end{itemize}

	Notez que chaque valeur commençant par un $\$$ est une variable que vous êtes libres de choisir.
	
	\subsection{PostgreSQL}
	
	L'installation de PostgreSQL se fait ainsi :
	
	\begin{lstlisting}[style=py]
		sudo apt-get install postgresql postgresql-contrib -y
		sudo -u postgres createdb $DJANGO_USER
	\end{lstlisting}
	
	Pour plus d'informations, référez vous à https://help.ubuntu.com/community/PostgreSQL.
	
	\subsection{Django}
	
	Pour installer django, il vous faut d'abord copier les sources du programme dans un dossier sur le serveur, ci-après nommé $\$DJANGO\_ROOT$.
	
	Il vous faut ensuite exécuter :
	
	\begin{lstlisting}[style=py]
		sudo apt-get install python3-pip python-virtualenv -y
		sudo virtualenv -p /usr/bin/python3 $DJANGO_ROOT/venv
		source $DJANGO_ROOT/venv/bin/activate
		pip3 install -r $DJANGO_ROOT/requirements.pip
	\end{lstlisting}
	
	Il vous faut ensuite créer un fichier $prod.py$ dans $\$DJANGO\_ROOT/rady/settings/$ avec la structure suivante :
	
	\begin{lstlisting}[style=py]
	"""
	Production configuration for Rady
	"""
	
	from rady.settings import *
	
	ALLOWED_HOSTS = ($YOUR_SERVER_NAME,)
	STATIC_ROOT = "$STATIC_FILES_INSTALLATION"
	
	# SECURITY WARNING: keep the secret key used in production secret!
	SECRET_KEY = 'CENSORED'
	
	DATABASES = {
	'default': {
	'ENGINE': "django.db.backends.postgresql_psycopg2",
	'NAME': "$DJANGO_USER",
	"USER": "$DJANGO_USER",
	"PASSWORD": "$PASSWORD",
	"HOST": "localhost"
	}
	}
	
	FCM_SETTINGS = {
	"FCM_SERVER_KEY": "YOUR_FCM_SERVER_KEY"
	}
	\end{lstlisting}
	
	Pour trouver votre clé FCM, il faut s'enregister sur $https://firebase.google.com/docs/cloud-messaging/$
	
	pour plus d'informations sur la configuration de Django, vous pouvez vous référer à $https://docs.djangoproject.com/en/1.10/topics/settings/$
	
	
	\subsection{UWSGI}
	
	Pour installer uwsgi, il vous faut exécuter les commandes suivantes :
	
	\begin{lstlisting}[style=py]
	sudo apt-get install python3-uwsgi uwsgi
	sudo systemctl enable uwsgi
	sudo systemctl start uwsgi
	\end{lstlisting}
	
	Et ajouter un fichier dans le dossier $/etc/uwsgi.d$ formé de cette manière :
	
	\begin{lstlisting}[style=py]
	[uwsgi]
	
	user		= $DJANGO_USER
	group		= $DJANGO_USER
	chdir		= $DJANGO_ROOT
	module          = rady.wsgi:application
	home            = $DJANGO_ROOT/venv
	master          = true
	processes       = 4
	socket          = /var/run/uwsgi/rady.sock
	chmod-socket    = 660
	vacuum          = true
	plugins		= python3
	manage-script-name = true
	touch-reload	= $DJANGO_ROOT/watch
	\end{lstlisting}
	
	Pour plus d'informations sur la configuration de UWSGI, vous pouvez vous référer à $https://uwsgi-docs.readthedocs.io/en/latest/$
	
	
	\subsection{Nginx}
	
	Pour installer Nginx, il faut exécuter les commandes suivantes :
	
	\begin{lstlisting}[style=py]
	sudo apt-get install nginx
	sudo systemctl enable nginx
	sudo systemctl start nginx
	\end{lstlisting}
	
	et ajouter une configuration dans le dossier $/etc/nginx.conf.d$
	
	\begin{lstlisting}[style=py]
	upstream django-rady {
		server unix:///var/run/uwsgi/rady.sock;
	}
	
	server {
	listen 443 ssl;
	charset     utf-8;

	server_name $YOUR_SERVER_NAME;
	
	# SECURITY CONFIGURATION
	ssl_certificate $YOUR_SSL_CERTIFICATE;
	ssl_certificate_key $YOUR_SSL_CERTIFICATE_KEY;
	
	ssl_protocols TLSv1.2;
	ssl_prefer_server_ciphers on;
	ssl_dhparam /etc/ssl/certs/dhparam.pem;
	
	add_header Strict-Transport-Security max-age=15768000;
	add_header X-Content-Type-Options "nosniff" always;
	add_header Access-Control-Allow-Origin *;
	
	index index.html;
	
	# Angular2 frontend
	location /  {
	gzip_static on;
	alias $WEBSITE;
	try_files $uri /index.html;
	expires epoch;
	
		location ~* \.(?:ico|css|js|png|svg)$ {
			expires max;
		}
	}
	
	# django backend
	location /api {
		expires epoch;
		include /etc/nginx/uwsgi_params;
		uwsgi_pass django-rady;
	}
	
	location /static {
		alias $STATIC_FILES_INSTALLATION;
	}
	
}
	
	\end{lstlisting}
	
	Pour plus d'informations, vous pouvez vous référer à la documentation officielle de Nginx : $https://www.nginx.com/resources/wiki/$.
	
	
	Il vous faut aussi copier les dossiers du site web dans le dossier $\$WEBSITE$.
	
	Ceux-ci peuvent être générés ainsi:
	
	\begin{lstlisting}[style=py]
	sudo apt-get install npm
	cd $PROJECT_ROOT/frontend
	npm install
	npm run build:prod
	\end{lstlisting}
	
	Les fichiers seront alors disponibles dans le dossier $\$PROJECT\_ROOT/frontend/dist$.


	\section{Application}
	
	Pour construire l'application, il faut tout d'abord installer npm et le sdk android.
	
	l'installation du SDK Android changeant régulièrement et étant passablement compliquée, nous préférons vous rediriger vers la documentation officielle : $https://developer.android.com/studio/index.html$
	
	Pour l'installation de npm, il faut exécuter la commande suivante :
	
	\begin{lstlisting}[style=py]
	sudo apt-get install npm
	\end{lstlisting}
	
	L'application peut ensuite se construire de cette manière :
	
	\begin{lstlisting}[style=py]
		cd $PROJECT_ROOT/app
		npm install
		npm run build:android
	\end{lstlisting}

\end{document}
